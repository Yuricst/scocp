
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Pykep Compatible Problems &#8212; scocp 0.1.7 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=3476fdda"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'examples/ex_pl2pl';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API" href="../api.html" />
    <link rel="prev" title="Astrodynamics Problems" href="../examples_astrodynamics.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="scocp 0.1.7 documentation - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="scocp 0.1.7 documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples_astrodynamics.html">Astrodynamics Problems</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Pykep Compatible Problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/examples/ex_pl2pl.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Pykep Compatible Problems</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Construct-a-fuel-optimal-problem">Construct a fuel-optimal problem</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Solve-fuel-optimal-problem">Solve fuel-optimal problem</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Plot-results">Plot results</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Verify-the-solution">Verify the solution</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="Pykep-Compatible-Problems">
<h1>Pykep Compatible Problems<a class="headerlink" href="#Pykep-Compatible-Problems" title="Link to this heading">#</a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">scocp_pykep</span></code> extension provides OCP classes that are made to be compatible with <code class="docutils literal notranslate"><span class="pre">pykep</span></code>’s <code class="docutils literal notranslate"><span class="pre">planet</span></code> module to define initial/final rendez-vous conditions.</p>
<blockquote>
<div><p>[!NOTE] Using the classes defined hereafter requires installing <code class="docutils literal notranslate"><span class="pre">scocp_pykep</span></code> as well as <code class="docutils literal notranslate"><span class="pre">scocp</span></code>. In fact, <code class="docutils literal notranslate"><span class="pre">scocp_pykep</span></code> has <code class="docutils literal notranslate"><span class="pre">scocp</span></code> as one of its dependencies.</p>
</div></blockquote>
<p>We consider a problem where:</p>
<ul class="simple">
<li><p>the initial and final conditions are to rendez-vous with planets following Keplerian motion around the central body (a star);</p></li>
<li><p>the initial mass (wet mass) is fixed, and the objective is to maximize the final mass;</p></li>
<li><p>at departure and arrival, a v-infinity vector with a user-defined upper-bound on magnitude may be used;</p></li>
<li><p>the departure time from the initial planet and the arrival time are free and bounded;</p></li>
</ul>
<p>This is analogous to <code class="docutils literal notranslate"><span class="pre">`pykep.trajopt.direct_pl2pl</span></code> &lt;<a class="reference external" href="https://esa.github.io/pykep/documentation/trajopt.html#pykep.trajopt.direct_pl2pl">https://esa.github.io/pykep/documentation/trajopt.html#pykep.trajopt.direct_pl2pl</a>&gt;`__.</p>
<p>We will start with some imports</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">pykep</span> <span class="k">as</span> <span class="nn">pk</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;../../..&quot;</span><span class="p">)</span>    <span class="c1"># path to scocp &amp; scocp_pykep at the root of the repo</span>
<span class="kn">import</span> <span class="nn">scocp</span>
<span class="kn">import</span> <span class="nn">scocp_pykep</span>
</pre></div>
</div>
</div>
<p>We now define our canonical scales.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define canonical parameters</span>
<span class="n">GM_SUN</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">MU_SUN</span>           <span class="c1"># Sun GM, m^3/s^-2</span>
<span class="n">MSTAR</span>  <span class="o">=</span> <span class="mf">800.0</span>               <span class="c1"># reference spacecraft mass</span>
<span class="n">G0</span>     <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">G0</span>               <span class="c1"># gravity at surface, m/s^2</span>

<span class="n">DU</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">AU</span>                   <span class="c1"># length scale set to Sun-Earth distance, m</span>
<span class="n">VU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">GM_SUN</span> <span class="o">/</span> <span class="n">DU</span><span class="p">)</span>    <span class="c1"># velocity scale, m/s</span>
<span class="n">TU</span> <span class="o">=</span> <span class="n">DU</span> <span class="o">/</span> <span class="n">VU</span>                 <span class="c1"># time scale, s</span>
</pre></div>
</div>
</div>
<p>We will define the initial and final <code class="docutils literal notranslate"><span class="pre">pykep.planet</span></code> objects (here chosen to be Earth and Mars), the initial departure epoch bounds (defined in MJD), and the arrival time bounds (defined with respect to the initial )</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define initial and final planets</span>
<span class="n">pl0</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">planet</span><span class="o">.</span><span class="n">jpl_lp</span><span class="p">(</span><span class="s1">&#39;earth&#39;</span><span class="p">)</span>
<span class="n">plf</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">planet</span><span class="o">.</span><span class="n">jpl_lp</span><span class="p">(</span><span class="s1">&#39;mars&#39;</span><span class="p">)</span>

<span class="n">t0_mjd2000_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1100.0</span><span class="p">,</span> <span class="mf">1200.0</span><span class="p">]</span>    <span class="c1"># initial epoch in mjd2000</span>
<span class="n">TU2DAY</span> <span class="o">=</span> <span class="n">TU</span> <span class="o">/</span> <span class="mf">86400.0</span>                   <span class="c1"># convert non-dimensional time to elapsed time in days</span>

<span class="c1"># define transfer problem discretization</span>
<span class="n">tf_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1200.0</span><span class="p">,</span> <span class="mf">1700.0</span><span class="p">]</span>
<span class="n">t0_guess</span> <span class="o">=</span> <span class="mf">1100.0</span>
<span class="n">tf_guess</span> <span class="o">=</span> <span class="mf">1600.0</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">s_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="o">*</span><span class="n">tf_guess</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">tf_guess</span><span class="p">]</span>

<span class="c1"># max v-infinity vector magnitudes</span>
<span class="n">vinf_dep</span> <span class="o">=</span> <span class="mf">1e3</span><span class="o">/</span><span class="mf">1e3</span>     <span class="c1"># 1000 m/s</span>
<span class="n">vinf_arr</span> <span class="o">=</span> <span class="mi">500</span><span class="o">/</span><span class="mf">1e3</span>     <span class="c1"># 500 m/s</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># spacecraft parameters</span>
<span class="n">ISP</span>    <span class="o">=</span> <span class="mf">3000.0</span>              <span class="c1"># specific impulse, s</span>
<span class="n">THRUST</span> <span class="o">=</span> <span class="mf">0.2</span>                 <span class="c1"># max thrust, kg.m/s^2</span>

<span class="c1"># this is the non-dimentional time integrator for solving the OCP</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">GM_SUN</span> <span class="o">/</span> <span class="p">(</span><span class="n">VU</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">DU</span><span class="p">)</span>                          <span class="c1"># canonical gravitational constant</span>
<span class="n">c1</span> <span class="o">=</span> <span class="n">THRUST</span> <span class="o">/</span> <span class="p">(</span><span class="n">MSTAR</span><span class="o">*</span><span class="n">DU</span><span class="o">/</span><span class="n">TU</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>                      <span class="c1"># canonical max thrust</span>
<span class="n">c2</span> <span class="o">=</span> <span class="n">THRUST</span><span class="o">/</span><span class="p">(</span><span class="n">ISP</span><span class="o">*</span><span class="n">G0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">MSTAR</span><span class="o">/</span><span class="n">TU</span><span class="p">)</span>                   <span class="c1"># canonical mass flow rate</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Canonical mu: </span><span class="si">{</span><span class="n">mu</span><span class="si">:</span><span class="s2">1.12e</span><span class="si">}</span><span class="s2">, c1: </span><span class="si">{</span><span class="n">c1</span><span class="si">:</span><span class="s2">1.4e</span><span class="si">}</span><span class="s2">, c2: </span><span class="si">{</span><span class="n">c2</span><span class="si">:</span><span class="s2">1.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">ta_dyn</span><span class="p">,</span> <span class="n">ta_dyn_aug</span> <span class="o">=</span> <span class="n">scocp_pykep</span><span class="o">.</span><span class="n">get_heyoka_integrator_twobody_mass</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">integrator_01domain</span> <span class="o">=</span> <span class="n">scocp_pykep</span><span class="o">.</span><span class="n">HeyokaIntegrator</span><span class="p">(</span>
    <span class="n">nx</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">nu</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">nv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">ta</span><span class="o">=</span><span class="n">ta_dyn</span><span class="p">,</span>
    <span class="n">ta_stm</span><span class="o">=</span><span class="n">ta_dyn_aug</span><span class="p">,</span>
    <span class="n">impulsive</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Canonical mu: 1.000000000000e+00, c1: 4.2158e-02, c2: 4.2681e-02
Building integrator for state only ... Done! Elapsed time: 0.2748 seconds
Building integrator for state + STM ... Done! Elapsed time: 39.7368 seconds
</pre></div></div>
</div>
<p>Building the integrator is a timely procedure - but we can e.g. pickle the <code class="docutils literal notranslate"><span class="pre">ta_dyn</span></code> and <code class="docutils literal notranslate"><span class="pre">ta_dyn_aug</span></code> to speed this up:)</p>
<section id="Construct-a-fuel-optimal-problem">
<h2>Construct a fuel-optimal problem<a class="headerlink" href="#Construct-a-fuel-optimal-problem" title="Link to this heading">#</a></h2>
<p>We now construct the optimal control problem class for sequential convex programming corresponding to a rendezvous between two <code class="docutils literal notranslate"><span class="pre">pykep.planet</span></code> objects.</p>
<p>Let <span class="math notranslate nohighlight">\(\boldsymbol{x}\)</span> denote the state</p>
<div class="math notranslate nohighlight">
\[\boldsymbol{x}(t) = [x(t),y(t),z(t),v_x(t),v_y(t),v_z(t),m(t)]\]</div>
<p>and <span class="math notranslate nohighlight">\(\boldsymbol{u}\)</span> denote the control</p>
<div class="math notranslate nohighlight">
\[\boldsymbol{u}(t) = [u_x(t),u_y(t),u_z(t)]\]</div>
<p>where <span class="math notranslate nohighlight">\(\| \boldsymbol{u} \|_2 = \Gamma \in [0,1]\)</span>.</p>
<p>The OCP we are solving is</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
    \min_{\boldsymbol{x},\boldsymbol{u},t_0,t_f}\quad&amp; m(t_f)
    \\ \text{s.t.} \quad&amp;
        \dot{\boldsymbol{x}} = \boldsymbol{f}(\boldsymbol{x}(t), \boldsymbol{u}(t), t)
    \\&amp;
        \begin{bmatrix} \boldsymbol{r}(t_0) \\ \boldsymbol{v}(t_0) \end{bmatrix} =
        \begin{bmatrix} \boldsymbol{r}_{\mathrm{pl0}}(t_0) \\ \boldsymbol{v}_{\mathrm{pl0}}(t_0) \end{bmatrix}
        + \begin{bmatrix} 0_{3\times1} \\ \Delta \boldsymbol{v}_{\infty 0} \end{bmatrix}
    \\&amp; m(t_0) = m_{\mathrm{init}}
    \\&amp;
        \begin{bmatrix} \boldsymbol{r}(t_f) \\ \boldsymbol{v}(t_f) \end{bmatrix} =
        \begin{bmatrix} \boldsymbol{r}_{\mathrm{plf}}(t_f) \\ \boldsymbol{v}_{\mathrm{plf}}(t_f) \end{bmatrix}
        + \begin{bmatrix} 0_{3\times1} \\ \Delta \boldsymbol{v}_{\infty f} \end{bmatrix}
    \\&amp; \| \Delta \boldsymbol{v}_{\infty 0} \|_2 \leq \Delta \boldsymbol{v}_{\infty 0, \max}
    \\&amp; \| \Delta \boldsymbol{v}_{\infty f} \|_2 \leq \Delta \boldsymbol{v}_{\infty f, \max}
\end{aligned}\end{split}\]</div>
<p>To solve variable-time optimal control problems, we define <span class="math notranslate nohighlight">\(\tau \in [0,1]\)</span> such that the physical time <span class="math notranslate nohighlight">\(t\)</span> is a function <span class="math notranslate nohighlight">\(t(\tau)\)</span> satisfying <span class="math notranslate nohighlight">\(t(0)=t_0\)</span> and <span class="math notranslate nohighlight">\(t(1) = t_f\)</span>. We define the augmented state <span class="math notranslate nohighlight">\(\tilde{\boldsymbol{x}}\)</span></p>
<div class="math notranslate nohighlight">
\[\tilde{\boldsymbol{x}}(\tau) = [x(\tau),y(\tau),z(\tau),v_x(\tau),v_y(\tau),v_z(\tau),m(\tau),t(\tau)]^T\]</div>
<p>and augmented control <span class="math notranslate nohighlight">\(\tilde{\boldsymbol{u}}\)</span></p>
<div class="math notranslate nohighlight">
\[\tilde{\boldsymbol{u}}(\tau) = [u_x(\tau),u_y(\tau),u_z(\tau),s(\tau),\Gamma(\tau)]^T\]</div>
<p>where <span class="math notranslate nohighlight">\(s = \mathrm{d}t/\mathrm{d}\tau\)</span>. The controlled dynamics for the augmented state is given by</p>
<div class="math notranslate nohighlight">
\[\begin{split}\tilde{\boldsymbol{x}}^{\prime} = \tilde{\boldsymbol{f}}(\tilde{\boldsymbol{x}}(\tau),\tilde{\boldsymbol{u}}(\tau),\tau)
=
s \begin{bmatrix}
    \boldsymbol{v}(\tau) \\[0.5em]
    -\dfrac{\mu}{r(\tau)^3} \boldsymbol{r}(\tau) \\
    0 \\
    0
\end{bmatrix}
+ s \begin{bmatrix}
    \boldsymbol{0}_{3\times1} \\[0.5em]
    \dfrac{c_1}{m(\tau)} \boldsymbol{u}(\tau) \\[0.5em]
    -c_2 \Gamma(\tau) \\[0.5em]
    1
\end{bmatrix}
=
\begin{bmatrix}
    s \boldsymbol{f}(\boldsymbol{x}(\tau),\boldsymbol{u}(\tau),t(\tau)) \\[0.5em]
    s
\end{bmatrix}
,\end{split}\]</div>
<p>We formulate the fixed-time OCP in terms of the augmented state</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
    \min_{\tilde{\boldsymbol{x}}, \tilde{\boldsymbol{u}}} \quad&amp; m(1)
    \\ \text{s.t.} \quad&amp;
        \tilde{\boldsymbol{x}}^{\prime} = \tilde{\boldsymbol{f}}(\tilde{\boldsymbol{x}}(\tau),\tilde{\boldsymbol{u}}(\tau),\tau)
    \\&amp;
        \begin{bmatrix} r(0) \\ v(0) \end{bmatrix} =
        \begin{bmatrix} r_{\mathrm{pl0}}(0) \\ v_{\mathrm{pl0}}(0) \end{bmatrix}
        + \begin{bmatrix} 0_{3\times1} \\ \Delta v_{\infty 0} \end{bmatrix}
    \\&amp; m(0) = m_{\mathrm{init}}
    \\&amp;
        \begin{bmatrix} r(1) \\ v(1) \end{bmatrix} =
        \begin{bmatrix} r_{\mathrm{plf}}(1) \\ v_{\mathrm{plf}}(1) \end{bmatrix}
        + \begin{bmatrix} 0_{3\times1} \\ \Delta v_{\infty f} \end{bmatrix}
    \\&amp; \| \Delta v_{\infty 0} \|_2 \leq \Delta v_{\infty 0, \max}
    \\&amp; \| \Delta v_{\infty f} \|_2 \leq \Delta v_{\infty f, \max}
\end{aligned}\end{split}\]</div>
<p>Note: in the code, we denote <span class="math notranslate nohighlight">\(\Gamma\)</span> with <code class="docutils literal notranslate"><span class="pre">v</span></code>.</p>
<p>The corresponding OCP class is <code class="docutils literal notranslate"><span class="pre">scocp_pykep.scocp_pl2pl</span></code>.</p>
<p>Note that we set <code class="docutils literal notranslate"><span class="pre">uniform_dilation</span> <span class="pre">=</span> <span class="pre">True</span></code>, which makes the control segment duration equal, i.e. <span class="math notranslate nohighlight">\(s_k = s_{k+1} \, \forall k\)</span>. This is found to result in more reliable convergence.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create problem</span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">scocp_pykep</span><span class="o">.</span><span class="n">scocp_pl2pl</span><span class="p">(</span>
    <span class="n">integrator_01domain</span><span class="p">,</span>
    <span class="n">pl0</span><span class="p">,</span>
    <span class="n">plf</span><span class="p">,</span>
    <span class="n">MSTAR</span><span class="p">,</span>
    <span class="n">pk</span><span class="o">.</span><span class="n">MU_SUN</span><span class="p">,</span>
    <span class="n">N</span><span class="p">,</span>
    <span class="n">t0_mjd2000_bounds</span><span class="p">,</span>
    <span class="n">tf_bounds</span><span class="p">,</span>
    <span class="n">s_bounds</span><span class="p">,</span>
    <span class="n">vinf_dep</span><span class="p">,</span>
    <span class="n">vinf_arr</span><span class="p">,</span>
    <span class="n">r_scaling</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">AU</span><span class="p">,</span>
    <span class="n">v_scaling</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">EARTH_VELOCITY</span><span class="p">,</span>
    <span class="n">uniform_dilation</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">objective_type</span> <span class="o">=</span> <span class="s2">&quot;mf&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>The SCv* star algorithm needs an initial guess, which doesn’t need to be feasible. The <code class="docutils literal notranslate"><span class="pre">scocp_pl2pl</span></code> class provides a method for generating one by linearly interpolating between the initial and final orbital elements. Note that we could use any other way to generate some initial guess - and the “better” the initial guess is, the faster SCvx* will converge to a (hopefully better) local minimum - but of course that’s not trivial:)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create initial guess</span>
<span class="n">xbar</span><span class="p">,</span> <span class="n">ubar</span><span class="p">,</span> <span class="n">vbar</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">get_initial_guess</span><span class="p">(</span><span class="n">t0_guess</span><span class="p">,</span> <span class="n">tf_guess</span><span class="p">)</span>
<span class="n">ybar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">,)</span>    <span class="c1"># initial guess for v-infinity vectors</span>
<span class="n">geq_nl_ig</span><span class="p">,</span> <span class="n">sols_ig</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">evaluate_nonlinear_dynamics</span><span class="p">(</span><span class="n">xbar</span><span class="p">,</span> <span class="n">ubar</span><span class="p">,</span> <span class="n">vbar</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>   <span class="c1"># evaluate initial guess</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max dynamics constraint violation: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">geq_nl_ig</span><span class="p">))</span><span class="si">:</span><span class="s2">1.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Max dynamics constraint violation: 1.9342e+00
</pre></div></div>
</div>
<p>Let’s see what our initial guess trajectory looks like:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># initial and final orbits</span>
<span class="n">initial_orbit_states</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">get_initial_orbit</span><span class="p">()</span>
<span class="n">final_orbit_states</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">get_final_orbit</span><span class="p">()</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;x, DU&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;y, DU&quot;</span><span class="p">,</span> <span class="n">zlabel</span><span class="o">=</span><span class="s2">&quot;z, DU&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">initial_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">initial_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">initial_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">final_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">final_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">final_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,(</span><span class="n">_ts</span><span class="p">,</span> <span class="n">_ys</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sols_ig</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Initial guess&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_ys</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">_ys</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">_ys</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ex_pl2pl_15_0.png" src="../_images/examples_ex_pl2pl_15_0.png" />
</div>
</div>
</section>
<section id="Solve-fuel-optimal-problem">
<h2>Solve fuel-optimal problem<a class="headerlink" href="#Solve-fuel-optimal-problem" title="Link to this heading">#</a></h2>
<p>We can now solve the problem! We construct an instance of the SCvx* algorithm (<code class="docutils literal notranslate"><span class="pre">scocp.SCvxStar</span></code>), then call <code class="docutils literal notranslate"><span class="pre">algo.solve()</span></code>. Make sure that the feasibility tolerance (here set to <code class="docutils literal notranslate"><span class="pre">tol_feas</span> <span class="pre">=</span> <span class="pre">1e-12</span></code>) is bigger than the integrator’s tolerance (using heyoka, we had set it to <code class="docutils literal notranslate"><span class="pre">1e-15</span></code>).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># setup algorithm &amp; solve</span>
<span class="n">tol_feas</span> <span class="o">=</span> <span class="mf">1e-12</span>
<span class="n">tol_opt</span> <span class="o">=</span> <span class="mf">1e-6</span>
<span class="n">algo</span> <span class="o">=</span> <span class="n">scocp</span><span class="o">.</span><span class="n">SCvxStar</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">tol_opt</span><span class="o">=</span><span class="n">tol_opt</span><span class="p">,</span> <span class="n">tol_feas</span><span class="o">=</span><span class="n">tol_feas</span><span class="p">,</span> <span class="n">rho1</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">r_bounds</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-10</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">])</span>
<span class="n">solution</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
    <span class="n">xbar</span><span class="p">,</span>
    <span class="n">ubar</span><span class="p">,</span>
    <span class="n">vbar</span><span class="p">,</span>
    <span class="n">ybar</span><span class="o">=</span><span class="n">ybar</span><span class="p">,</span>
    <span class="n">maxiter</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span>
<span class="n">xopt</span><span class="p">,</span> <span class="n">uopt</span><span class="p">,</span> <span class="n">vopt</span><span class="p">,</span> <span class="n">yopt</span><span class="p">,</span> <span class="n">sols</span><span class="p">,</span> <span class="n">summary_dict</span> <span class="o">=</span> <span class="n">solution</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">solution</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">solution</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">solution</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">solution</span><span class="o">.</span><span class="n">sols</span><span class="p">,</span> <span class="n">solution</span><span class="o">.</span><span class="n">summary_dict</span>
<span class="k">assert</span> <span class="n">summary_dict</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Optimal&quot;</span>
<span class="k">assert</span> <span class="n">summary_dict</span><span class="p">[</span><span class="s2">&quot;chi&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tol_feas</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

|  Iter  |     J0      |   Delta J   |   Delta L   |    chi     |     rho     |     r      |   weight   | step acpt. |
     1   | -6.0000e-01 |  1.2014e+02 |  1.1926e+02 | 1.7508e+00 |  1.0074e+00 | 1.0000e-01 | 1.0000e+02 |    yes     |
     2   | -4.0513e-01 |  6.6707e+02 |  6.6162e+02 | 1.1883e+00 |  1.0082e+00 | 3.0000e-01 | 2.0000e+02 |    yes     |
     3   | -9.1238e-01 |  6.1728e+02 |  6.5942e+02 | 5.3879e-01 |  9.3610e-01 | 9.0000e-01 | 2.0000e+02 |    yes     |
     4   | -1.1192e+00 |  5.4589e+01 |  1.0768e+02 | 9.0536e-01 |  5.0695e-01 | 2.7000e+00 | 2.0000e+02 |    yes     |
     5   | -9.1012e-01 |  5.0343e+02 |  5.3983e+02 | 1.2299e-01 |  9.3257e-01 | 2.7000e+00 | 4.0000e+02 |    yes     |
     6   | -1.0233e+00 |  3.2815e+01 |  3.6607e+01 | 1.3704e-01 |  8.9641e-01 | 8.1000e+00 | 4.0000e+02 |    yes     |
     7   | -9.8076e-01 | -1.5074e+02 |  2.6732e+01 | 2.2045e-01 | -5.6391e+00 | 1.0000e+01 | 8.0000e+02 |    no      |
     8   | -9.8076e-01 | -1.5074e+02 |  2.6732e+01 | 2.2045e-01 | -5.6392e+00 | 5.0000e+00 | 8.0000e+02 |    no      |
     9   | -9.8076e-01 | -1.5074e+02 |  2.6732e+01 | 2.2046e-01 | -5.6392e+00 | 2.5000e+00 | 8.0000e+02 |    no      |
    10   | -9.8076e-01 | -1.5074e+02 |  2.6732e+01 | 2.2046e-01 | -5.6392e+00 | 1.2500e+00 | 8.0000e+02 |    no      |

|  Iter  |     J0      |   Delta J   |   Delta L   |    chi     |     rho     |     r      |   weight   | step acpt. |
    11   | -9.2113e-01 | -2.0195e+01 |  2.6665e+01 | 9.9606e-02 | -7.5737e-01 | 6.2500e-01 | 8.0000e+02 |    no      |
    12   | -8.0011e-01 |  2.2655e+01 |  2.6525e+01 | 2.9513e-02 |  8.5410e-01 | 3.1250e-01 | 8.0000e+02 |    yes     |
    13   | -9.1664e-01 | -2.6649e+02 |  1.7593e+01 | 2.0205e-01 | -1.5148e+01 | 9.3750e-01 | 1.6000e+03 |    no      |
    14   | -8.7375e-01 | -3.0908e+01 |  1.7548e+01 | 7.5244e-02 | -1.7614e+00 | 4.6875e-01 | 1.6000e+03 |    no      |
    15   | -8.3565e-01 |  1.6248e+01 |  1.7509e+01 | 1.4414e-02 |  9.2800e-01 | 2.3438e-01 | 1.6000e+03 |    yes     |
    16   | -8.3476e-01 | -1.3318e+02 |  5.1706e+00 | 1.1921e-01 | -2.5756e+01 | 7.0312e-01 | 3.2000e+03 |    no      |
    17   | -8.3225e-01 | -2.5755e+01 |  5.1680e+00 | 4.9517e-02 | -4.9835e+00 | 3.5156e-01 | 3.2000e+03 |    no      |
    18   | -8.2598e-01 |  3.2964e+00 |  5.1620e+00 | 9.5506e-03 |  6.3858e-01 | 1.7578e-01 | 3.2000e+03 |    yes     |
    19   | -8.5044e-01 |  5.7589e-01 |  4.7244e+00 | 7.3733e-03 |  1.2190e-01 | 1.7578e-01 | 6.4000e+03 |    yes     |
    20   | -8.6124e-01 |  3.8856e-01 |  9.0381e+00 | 8.2036e-03 |  4.2992e-02 | 1.7578e-01 | 1.2800e+04 |    yes     |

|  Iter  |     J0      |   Delta J   |   Delta L   |    chi     |     rho     |     r      |   weight   | step acpt. |
    21   | -8.6196e-01 |  1.0240e+00 |  1.8020e+01 | 8.0302e-03 |  5.6824e-02 | 1.7578e-01 | 2.5600e+04 |    yes     |
    22   | -8.6436e-01 |  2.7243e+00 |  3.4431e+01 | 7.6529e-03 |  7.9124e-02 | 1.7578e-01 | 5.1200e+04 |    yes     |
    23   | -8.6593e-01 |  1.3332e-01 |  6.2646e+01 | 7.3862e-03 |  2.1281e-03 | 1.7578e-01 | 1.0240e+05 |    yes     |
    24   | -8.6318e-01 |  1.0717e+02 |  1.2672e+02 | 4.4721e-03 |  8.4574e-01 | 1.7578e-01 | 2.0480e+05 |    yes     |
    25   | -8.6062e-01 | -9.1653e+03 |  1.9545e+01 | 1.2601e-01 | -4.6894e+02 | 5.2734e-01 | 2.0480e+05 |    no      |
    26   | -8.5795e-01 | -6.1359e+02 |  1.9542e+01 | 2.5069e-02 | -3.1399e+01 | 2.6367e-01 | 2.0480e+05 |    no      |
    27   | -8.5646e-01 | -2.0257e+01 |  1.9541e+01 | 1.4816e-03 | -1.0367e+00 | 1.3184e-01 | 2.0480e+05 |    no      |
    28   | -8.5568e-01 |  1.7110e+01 |  1.9540e+01 | 5.5312e-03 |  8.7563e-01 | 6.5918e-02 | 2.0480e+05 |    yes     |
    29   | -8.7163e-01 | -4.0019e+02 |  2.2918e+01 | 1.7274e-02 | -1.7462e+01 | 1.9775e-01 | 4.0960e+05 |    no      |
    30   | -8.6968e-01 | -2.1494e+00 |  2.2916e+01 | 3.1902e-03 | -9.3794e-02 | 9.8877e-02 | 4.0960e+05 |    no      |

|  Iter  |     J0      |   Delta J   |   Delta L   |    chi     |     rho     |     r      |   weight   | step acpt. |
    31   | -8.6869e-01 |  2.1520e+01 |  2.2915e+01 | 2.6683e-04 |  9.3912e-01 | 4.9438e-02 | 4.0960e+05 |    yes     |
    32   | -8.6751e-01 | -9.5090e+01 |  1.4186e+00 | 5.1811e-03 | -6.7032e+01 | 1.4832e-01 | 8.1920e+05 |    no      |
    33   | -8.6704e-01 | -1.4178e+01 |  1.4181e+00 | 2.1273e-03 | -9.9979e+00 | 7.4158e-02 | 8.1920e+05 |    no      |
    34   | -8.6664e-01 |  4.7426e-01 |  1.4177e+00 | 1.9597e-04 |  3.3453e-01 | 3.7079e-02 | 8.1920e+05 |    yes     |
    35   | -8.6686e-01 | -3.7750e-01 |  9.8878e-01 | 3.1454e-04 | -3.8178e-01 | 3.7079e-02 | 1.6384e+06 |    no      |
    36   | -8.6680e-01 |  8.9800e-01 |  9.8871e-01 | 1.6392e-04 |  9.0825e-01 | 1.8539e-02 | 1.6384e+06 |    yes     |
    37   | -8.6711e-01 | -1.1932e+01 |  2.3918e-01 | 1.2722e-03 | -4.9887e+01 | 5.5618e-02 | 3.2768e+06 |    no      |
    38   | -8.6705e-01 | -6.1569e-01 |  2.3912e-01 | 2.7680e-04 | -2.5748e+00 | 2.7809e-02 | 3.2768e+06 |    no      |
    39   | -8.6702e-01 |  1.8087e-01 |  2.3909e-01 | 4.4208e-05 |  7.5650e-01 | 1.3905e-02 | 3.2768e+06 |    yes     |
    40   | -8.6720e-01 | -1.1833e+01 |  7.3247e-02 | 7.0007e-04 | -1.6155e+02 | 4.1714e-02 | 6.5536e+06 |    no      |

|  Iter  |     J0      |   Delta J   |   Delta L   |    chi     |     rho     |     r      |   weight   | step acpt. |
    41   | -8.6713e-01 | -7.5656e-01 |  7.3180e-02 | 1.5501e-04 | -1.0338e+01 | 2.0857e-02 | 6.5536e+06 |    no      |
    42   | -8.6709e-01 |  2.1174e-02 |  7.3145e-02 | 1.6458e-05 |  2.8948e-01 | 1.0428e-02 | 6.5536e+06 |    yes     |
    43   | -8.6712e-01 |  1.2316e-02 |  9.3265e-02 | 2.4774e-05 |  1.3205e-01 | 1.0428e-02 | 1.3107e+07 |    yes     |
    44   | -8.6716e-01 | -4.6222e-02 |  1.5165e-01 | 2.4652e-05 | -3.0481e-01 | 1.0428e-02 | 2.6214e+07 |    no      |
    45   | -8.6715e-01 |  1.3940e-01 |  1.5163e-01 | 1.2489e-05 |  9.1934e-01 | 5.2142e-03 | 2.6214e+07 |    yes     |
    46   | -8.6720e-01 | -1.5634e+00 |  4.2112e-03 | 8.6251e-05 | -3.7124e+02 | 1.5643e-02 | 5.2429e+07 |    no      |
    47   | -8.6718e-01 | -1.2160e-01 |  4.1900e-03 | 2.1615e-05 | -2.9021e+01 | 7.8213e-03 | 5.2429e+07 |    no      |
    48   | -8.6716e-01 | -3.5485e-03 |  4.1771e-03 | 7.6178e-07 | -8.4952e-01 | 3.9107e-03 | 5.2429e+07 |    no      |
    49   | -8.6716e-01 |  3.6876e-03 |  4.1707e-03 | 4.4575e-06 |  8.8417e-01 | 1.9553e-03 | 5.2429e+07 |    yes     |
    50   | -8.6718e-01 | -7.6964e-02 |  4.1607e-03 | 1.4768e-05 | -1.8498e+01 | 5.8660e-03 | 1.0486e+08 |    no      |

|  Iter  |     J0      |   Delta J   |   Delta L   |    chi     |     rho     |     r      |   weight   | step acpt. |
    51   | -8.6717e-01 | -8.4867e-04 |  4.1501e-03 | 3.0435e-06 | -2.0449e-01 | 2.9330e-03 | 1.0486e+08 |    no      |
    52   | -8.6716e-01 |  3.8377e-03 |  4.1448e-03 | 1.8394e-07 |  9.2590e-01 | 1.4665e-03 | 1.0486e+08 |    yes     |
    53   | -8.6718e-01 | -5.0832e-02 |  2.6826e-04 | 8.3057e-06 | -1.8949e+02 | 4.3995e-03 | 2.0972e+08 |    no      |
    54   | -8.6717e-01 | -2.8817e-03 |  2.6022e-04 | 1.7119e-06 | -1.1074e+01 | 2.1997e-03 | 2.0972e+08 |    no      |
    55   | -8.6717e-01 |  6.3488e-05 |  2.5619e-04 | 6.1578e-08 |  2.4781e-01 | 1.0999e-03 | 2.0972e+08 |    yes     |
    56   | -8.6717e-01 | -2.4183e-04 |  1.4672e-04 | 2.7569e-07 | -1.6482e+00 | 1.0999e-03 | 4.1943e+08 |    no      |
    57   | -8.6717e-01 |  1.2072e-04 |  1.4469e-04 | 1.3741e-07 |  8.3435e-01 | 5.4994e-04 | 4.1943e+08 |    yes     |
    58   | -8.6718e-01 | -4.0256e-03 |  1.8869e-05 | 1.1696e-06 | -2.1334e+02 | 1.6498e-03 | 8.3886e+08 |    no      |
    59   | -8.6717e-01 | -2.3284e-04 |  1.5782e-05 | 2.4144e-07 | -1.4753e+01 | 8.2491e-04 | 8.3886e+08 |    no      |
    60   | -8.6717e-01 | -1.0537e-06 |  1.4238e-05 | 8.8810e-09 | -7.4005e-02 | 4.1245e-04 | 8.3886e+08 |    no      |

|  Iter  |     J0      |   Delta J   |   Delta L   |    chi     |     rho     |     r      |   weight   | step acpt. |
    61   | -8.6717e-01 |  1.2514e-05 |  1.3464e-05 | 4.9502e-08 |  9.2942e-01 | 2.0623e-04 | 8.3886e+08 |    yes     |
    62   | -8.6717e-01 | -1.4887e-04 |  1.0362e-05 | 1.6524e-07 | -1.4367e+01 | 6.1868e-04 | 1.6777e+09 |    no      |
    63   | -8.6717e-01 | -6.2940e-07 |  9.1947e-06 | 3.4252e-08 | -6.8453e-02 | 3.0934e-04 | 1.6777e+09 |    no      |
    64   | -8.6717e-01 |  8.0028e-06 |  8.6104e-06 | 1.6701e-09 |  9.2944e-01 | 1.5467e-04 | 1.6777e+09 |    yes     |
    65   | -8.6717e-01 | -9.8509e-05 |  2.2445e-06 | 9.3166e-08 | -4.3890e+01 | 4.6401e-04 | 3.3554e+09 |    no      |
    66   | -8.6717e-01 | -4.8499e-06 |  1.3673e-06 | 1.9355e-08 | -3.5471e+00 | 2.3200e-04 | 3.3554e+09 |    no      |
    67   | -8.6717e-01 |  5.4492e-07 |  9.2823e-07 | 7.6734e-10 |  5.8705e-01 | 1.1600e-04 | 3.3554e+09 |    yes     |
    68   | -8.6717e-01 | -4.8605e-08 |  7.2696e-07 | 3.1875e-09 | -6.6861e-02 | 1.1600e-04 | 6.7109e+09 |    no      |
    69   | -8.6717e-01 |  4.5872e-07 |  5.0714e-07 | 1.5267e-09 |  9.0453e-01 | 5.8001e-05 | 6.7109e+09 |    yes     |
    70   | -8.6717e-01 | -7.2966e-06 |  6.8515e-07 | 1.3311e-08 | -1.0650e+01 | 1.7400e-04 | 1.3422e+10 |    no      |

|  Iter  |     J0      |   Delta J   |   Delta L   |    chi     |     rho     |     r      |   weight   | step acpt. |
    71   | -8.6717e-01 | -1.4601e-07 |  3.5531e-07 | 2.8055e-09 | -4.1094e-01 | 8.7002e-05 | 1.3422e+10 |    no      |
    72   | -8.6717e-01 |  1.5797e-07 |  1.8918e-07 | 1.2863e-10 |  8.3502e-01 | 4.3501e-05 | 1.3422e+10 |    yes     |
    73   | -8.6717e-01 | -4.6036e-06 |  5.2031e-07 | 7.5501e-09 | -8.8477e+00 | 1.3050e-04 | 2.6844e+10 |    no      |
    74   | -8.6717e-01 | -5.5861e-08 |  2.7238e-07 | 1.6035e-09 | -2.0509e-01 | 6.5251e-05 | 2.6844e+10 |    no      |
    75   | -8.6717e-01 |  1.2752e-07 |  1.4910e-07 | 2.1875e-10 |  8.5523e-01 | 3.2626e-05 | 2.6844e+10 |    yes     |
    76   | -8.6717e-01 | -2.8652e-06 |  3.9551e-07 | 4.2941e-09 | -7.2442e+00 | 9.7877e-05 | 5.3687e+10 |    no      |
    77   | -8.6717e-01 | -9.1764e-09 |  1.9977e-07 | 9.2078e-10 | -4.5936e-02 | 4.8938e-05 | 5.3687e+10 |    no      |
    78   | -8.6717e-01 |  9.9762e-08 |  1.1314e-07 | 4.8900e-11 |  8.8177e-01 | 2.4469e-05 | 5.3687e+10 |    yes     |
    79   | -8.6717e-01 | -1.8227e-06 |  2.8979e-07 | 2.4509e-09 | -6.2897e+00 | 7.3408e-05 | 1.0737e+11 |    no      |
    80   | -8.6717e-01 |  1.1611e-08 |  1.5007e-07 | 5.3204e-10 |  7.7370e-02 | 3.6704e-05 | 1.0737e+11 |    yes     |

|  Iter  |     J0      |   Delta J   |   Delta L   |    chi     |     rho     |     r      |   weight   | step acpt. |
    81   | -8.6717e-01 |  3.2320e-07 |  5.9606e-07 | 3.4786e-10 |  5.4222e-01 | 3.6704e-05 | 2.1475e+11 |    yes     |
    82   | -8.6717e-01 |  2.1141e-07 |  6.4914e-07 | 3.3308e-10 |  3.2567e-01 | 3.6704e-05 | 4.2950e+11 |    yes     |
    83   | -8.6717e-01 | -6.5343e-08 |  1.0323e-06 | 4.0269e-10 | -6.3298e-02 | 3.6704e-05 | 8.5899e+11 |    no      |
    84   | -8.6717e-01 |  8.8975e-07 |  9.7667e-07 | 1.8074e-10 |  9.1101e-01 | 1.8352e-05 | 8.5899e+11 |    yes     |
    85   | -8.6717e-01 | -1.1275e-05 |  3.5087e-07 | 1.4054e-09 | -3.2134e+01 | 5.5056e-05 | 1.7180e+12 |    no      |
    86   | -8.6717e-01 | -5.1184e-07 |  2.4541e-07 | 3.0979e-10 | -2.0856e+00 | 2.7528e-05 | 1.7180e+12 |    no      |
    87   | -8.6717e-01 |  1.3294e-07 |  1.9315e-07 | 2.0221e-11 |  6.8828e-01 | 1.3764e-05 | 1.7180e+12 |    yes     |
    88   | -8.6717e-01 | -1.7391e-08 |  1.0519e-07 | 5.8912e-11 | -1.6534e-01 | 1.3764e-05 | 3.4360e+12 |    no      |
    89   | -8.6717e-01 |  6.6954e-08 |  7.6095e-08 | 6.4937e-11 |  8.7988e-01 | 6.8820e-06 | 3.4360e+12 |    yes     |
    90   | -8.6717e-01 | -7.3369e-07 |  1.0465e-07 | 2.1655e-10 | -7.0109e+00 | 2.0646e-05 | 6.8719e+12 |    no      |

|  Iter  |     J0      |   Delta J   |   Delta L   |    chi     |     rho     |     r      |   weight   | step acpt. |
    91   | -8.6717e-01 | -2.8923e-10 |  5.9439e-08 | 4.8680e-11 | -4.8660e-03 | 1.0323e-05 | 6.8719e+12 |    no      |
    92   | -8.6717e-01 |  4.0862e-08 |  5.1179e-08 | 2.7143e-11 |  7.9842e-01 | 5.1615e-06 | 6.8719e+12 |    yes     |
    93   | -8.6717e-01 | -3.5465e-07 |  6.3779e-08 | 1.1975e-10 | -5.5606e+00 | 1.5484e-05 | 1.3744e+13 |    no      |
    94   | -8.6717e-01 | -1.2104e-08 |  5.2325e-08 | 3.3005e-11 | -2.3133e-01 | 7.7422e-06 | 1.3744e+13 |    no      |
    95   | -8.6717e-01 |  1.6958e-08 |  2.5522e-08 | 6.1197e-12 |  6.6443e-01 | 3.8711e-06 | 1.3744e+13 |    yes     |
    96   | -8.6717e-01 |  1.2097e-08 |  3.1393e-08 | 2.4169e-11 |  3.8535e-01 | 3.8711e-06 | 2.7488e+13 |    yes     |
    97   | -8.6717e-01 |  4.3505e-08 |  8.0304e-08 | 2.0864e-11 |  5.4176e-01 | 3.8711e-06 | 5.4976e+13 |    yes     |
    98   | -8.6717e-01 |  4.7334e-08 |  1.3450e-07 | 2.5307e-11 |  3.5193e-01 | 3.8711e-06 | 1.0995e+14 |    yes     |
    99   | -8.6717e-01 |  1.3888e-07 |  3.0334e-07 | 2.5107e-11 |  4.5783e-01 | 3.8711e-06 | 2.1990e+14 |    yes     |
   100   | -8.6717e-01 |  3.2921e-07 |  5.8709e-07 | 1.8135e-11 |  5.6075e-01 | 3.8711e-06 | 4.3980e+14 |    yes     |

|  Iter  |     J0      |   Delta J   |   Delta L   |    chi     |     rho     |     r      |   weight   | step acpt. |
   101   | -8.6717e-01 |  9.9142e-08 |  7.3739e-07 | 1.9760e-11 |  1.3445e-01 | 3.8711e-06 | 8.7961e+14 |    yes     |
   102   | -8.6717e-01 |  8.7703e-07 |  1.9082e-06 | 1.3132e-11 |  4.5960e-01 | 3.8711e-06 | 1.7592e+15 |    yes     |
   103   | -8.6717e-01 |  1.0090e-06 |  2.5275e-06 | 1.4608e-11 |  3.9921e-01 | 3.8711e-06 | 3.5184e+15 |    yes     |
   104   | -8.6717e-01 | -1.7637e-06 |  3.5056e-06 | 2.4555e-11 | -5.0311e-01 | 3.8711e-06 | 7.0369e+15 |    no      |
   105   | -8.6717e-01 |  2.1866e-06 |  3.4942e-06 | 3.1078e-12 |  6.2578e-01 | 1.9356e-06 | 7.0369e+15 |    yes     |
   106   | -8.6717e-01 | -6.0691e-07 |  1.4806e-06 | 1.2204e-11 | -4.0991e-01 | 1.9356e-06 | 1.4074e+16 |    no      |
   107   | -8.6717e-01 |  6.8874e-07 |  1.4768e-06 | 6.1007e-13 |  4.6637e-01 | 9.6778e-07 | 1.4074e+16 |    yes     |


    SCvx* algorithm summary:
        Status                          : Optimal
        Objective value                 : -8.67172738e-01
        Penalized objective improvement : 6.88741769e-07 (tol: 1.0000e-06)
        Constraint violation            : 6.10067552e-13 (tol: 1.0000e-12)
        Total iterations                : 107
        SCvx* algorithm time            : 25.4275 seconds


</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">problem</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

 ********* Trajectory summary *********
   Objective type       : mf
   Departure            : 1199.5133 MJD
   Arrival              : 1539.4673 MJD
   TOF                  : 439.4673 days
   Final mass           : 693.7382 kg
   Departure v-infinity : 1000.00 m/s
   Arrival v-infinity   : 500.00 m/s


</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># evaluate nonlinear violations</span>
<span class="n">geq_nl_opt</span><span class="p">,</span> <span class="n">sols</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">evaluate_nonlinear_dynamics</span><span class="p">(</span><span class="n">xopt</span><span class="p">,</span> <span class="n">uopt</span><span class="p">,</span> <span class="n">vopt</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max dynamics constraint violation: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">geq_nl_opt</span><span class="p">))</span><span class="si">:</span><span class="s2">1.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">geq_nl_opt</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">tol_feas</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Max dynamics constraint violation: 3.5438e-13
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract solution</span>
<span class="n">ts_mjd2000</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">controls</span><span class="p">,</span> <span class="n">v_infinities</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">process_solution</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ts_mjd2000.shape = </span><span class="si">{</span><span class="n">ts_mjd2000</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;states.shape = </span><span class="si">{</span><span class="n">states</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;controls.shape = </span><span class="si">{</span><span class="n">controls</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ts_mjd2000.shape = (31,)
states.shape = (31, 7)
controls.shape = (30, 3)
</pre></div></div>
</div>
<p>In the above,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ts_mjd2000</span></code> is a 1D array of the time-stamps of the <code class="docutils literal notranslate"><span class="pre">N+1</span></code> nodes in MJD,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">controls</span></code> is a 2D array containing the thrust throttles in each row for the <code class="docutils literal notranslate"><span class="pre">N</span></code> control segments (remember we solved this via a stark model, i.e. constant thrust is applied across the segment),</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">states</span></code> is a 2D array containing the cartesian state and mass of the spacecraft at the beginning of each node, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">v_infinities</span></code> is a list containing the initial and final v-infinity vectors</p></li>
</ul>
<section id="Plot-results">
<h3>Plot results<a class="headerlink" href="#Plot-results" title="Link to this heading">#</a></h3>
<p>Let’s plot the results! Let’s first look at our controlled trajectory:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot trajectory</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">target_initial</span><span class="o">.</span><span class="n">target_state</span><span class="p">(</span><span class="n">xopt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span>
<span class="n">xf</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">target_final</span><span class="o">.</span><span class="n">target_state</span><span class="p">(</span><span class="n">xopt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">zlabel</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">_ts</span><span class="p">,</span> <span class="n">_ys</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sols_ig</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_ys</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">_ys</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">_ys</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">_ts</span><span class="p">,</span> <span class="n">_ys</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sols</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_ys</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">_ys</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">_ys</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">)</span>
    <span class="n">_us_zoh</span> <span class="o">=</span> <span class="n">scocp</span><span class="o">.</span><span class="n">zoh_controls</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">uopt</span><span class="p">,</span> <span class="n">_ts</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">_ys</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">_ys</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">_ys</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">_us_zoh</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">_us_zoh</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">_us_zoh</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial state&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Final state&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">initial_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">initial_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">initial_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">final_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">final_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">final_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="c1"># ax.set_aspect(&#39;equal&#39;)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;x, DU&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;y, DU&quot;</span><span class="p">,</span> <span class="n">zlabel</span><span class="o">=</span><span class="s2">&quot;z, DU&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ex_pl2pl_23_0.png" src="../_images/examples_ex_pl2pl_23_0.png" />
</div>
</div>
<p>Let’s also look at the mass history and the control history:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax_m</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax_m</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">_ts</span><span class="p">,</span> <span class="n">_ys</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sols</span><span class="p">:</span>
    <span class="n">ax_m</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_ys</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">problem</span><span class="o">.</span><span class="n">TU2DAY</span><span class="p">,</span> <span class="n">_ys</span><span class="p">[:,</span><span class="mi">6</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">)</span>
<span class="n">ax_m</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">sols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax_m</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xopt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">problem</span><span class="o">.</span><span class="n">TU2DAY</span><span class="p">,</span> <span class="mf">0.01</span> <span class="o">+</span> <span class="n">sols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;m_f = </span><span class="si">{</span><span class="n">sols</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span><span class="si">:</span><span class="s2">1.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax_m</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time, days&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Mass, MU&quot;</span><span class="p">)</span>
<span class="c1">#ax_m.legend()</span>

<span class="n">ax_u</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax_u</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax_u</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">xopt</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">problem</span><span class="o">.</span><span class="n">TU2DAY</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">vopt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">])),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Gamma&quot;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax_u</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">xopt</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">problem</span><span class="o">.</span><span class="n">TU2DAY</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">uopt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">])),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax_u</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">xopt</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">problem</span><span class="o">.</span><span class="n">TU2DAY</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">uopt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">])),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">ax_u</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">xopt</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">problem</span><span class="o">.</span><span class="n">TU2DAY</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">uopt</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">])),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">ax_u</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time, days&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Control throttle&quot;</span><span class="p">)</span>
<span class="n">ax_u</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ex_pl2pl_25_0.png" src="../_images/examples_ex_pl2pl_25_0.png" />
</div>
</div>
<p>Let’s also see the convergence of the SCVx* algorithm - we will look at the iterates of <span class="math notranslate nohighlight">\(|\Delta J|\)</span>, i.e. the actual cost reduction in a single SCP step, and <span class="math notranslate nohighlight">\(\chi\)</span>, i.e. max nonlinear constraint violation at a given SCP step:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax_DeltaJ</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax_DeltaJ</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">algo</span><span class="o">.</span><span class="n">plot_DeltaJ</span><span class="p">(</span><span class="n">ax_DeltaJ</span><span class="p">,</span> <span class="n">summary_dict</span><span class="p">)</span>
<span class="n">ax_DeltaJ</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">tol_opt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;tol_opt&#39;</span><span class="p">)</span>
<span class="n">ax_DeltaJ</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax_DeltaL</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax_DeltaL</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">algo</span><span class="o">.</span><span class="n">plot_chi</span><span class="p">(</span><span class="n">ax_DeltaL</span><span class="p">,</span> <span class="n">summary_dict</span><span class="p">)</span>
<span class="n">ax_DeltaL</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">tol_feas</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;tol_feas&#39;</span><span class="p">)</span>
<span class="n">ax_DeltaL</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ex_pl2pl_27_0.png" src="../_images/examples_ex_pl2pl_27_0.png" />
</div>
</div>
</section>
</section>
<section id="Verify-the-solution">
<h2>Verify the solution<a class="headerlink" href="#Verify-the-solution" title="Link to this heading">#</a></h2>
<p>Let us now check if our constructed trajectory is dynamically feasible via forward single-shot propagation (remember: the dynamics was enforced in a multiple-shooting sence within the OCP). For this, we make use of <code class="docutils literal notranslate"><span class="pre">pykep.propagate_taylor</span></code> (from pykep 2.X) or <code class="docutils literal notranslate"><span class="pre">pykep.stark_problem</span></code> (from pykep 3.X).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts_mjd2000</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">controls</span><span class="p">,</span> <span class="n">v_infinities</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">process_solution</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x0_iter</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>     <span class="c1"># initial spacecraft state</span>
<span class="n">states_singleshoot</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0_iter</span><span class="p">,]</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">u0</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ts_mjd2000</span><span class="p">,</span> <span class="n">controls</span><span class="p">)),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">controls</span><span class="p">)):</span>
    <span class="n">r</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">propagate_taylor</span><span class="p">(</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">x0_iter</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">x0_iter</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span>
        <span class="n">m0</span> <span class="o">=</span> <span class="n">x0_iter</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
        <span class="n">thrust</span> <span class="o">=</span> <span class="n">THRUST</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u0</span><span class="p">),</span>
        <span class="n">tof</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts_mjd2000</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ts_mjd2000</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">*</span><span class="mi">86400</span><span class="p">,</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">MU_SUN</span><span class="p">,</span>
        <span class="n">veff</span> <span class="o">=</span> <span class="n">ISP</span><span class="o">*</span><span class="n">G0</span><span class="p">,</span>
        <span class="n">log10tol</span> <span class="o">=-</span><span class="mi">15</span><span class="p">,</span>
        <span class="n">log10rtol</span> <span class="o">=</span> <span class="o">-</span><span class="mi">15</span><span class="p">)</span>

    <span class="c1"># update spacecraft state</span>
    <span class="n">x0_iter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">v</span><span class="p">,[</span><span class="n">m</span><span class="p">]))</span>

    <span class="n">states_singleshoot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">x0_iter</span><span class="p">))</span>
<span class="n">states_singleshoot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">states_singleshoot</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "df801629325b4d41b02200158ab0ddf6", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dx_final</span> <span class="o">=</span> <span class="n">states_singleshoot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">plf</span><span class="o">.</span><span class="n">eph</span><span class="p">(</span><span class="n">ts_mjd2000</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>  <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">v_infinities</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final position offset: </span><span class="si">{</span><span class="n">dx_final</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mf">1e3</span><span class="si">}</span><span class="s2"> km&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final velocity offset: </span><span class="si">{</span><span class="n">dx_final</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="si">}</span><span class="s2"> m/s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Final position offset: [-176.91088161  -30.19200256    1.14562381] km
Final velocity offset: [-0.00328417 -0.01671438 -0.00014991] m/s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">zlabel</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">_ts</span><span class="p">,</span> <span class="n">_ys</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sols</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_ys</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="n">_ys</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="n">_ys</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">states_singleshoot</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">states_singleshoot</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">states_singleshoot</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;r:&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="n">x0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial state&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="n">xf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="n">xf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Final state&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">initial_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="n">initial_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="n">initial_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">final_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="n">final_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="n">final_orbit_states</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">DU</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>


<span class="n">axm</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axm</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axm</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time, days&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Mass, kg&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">_ts</span><span class="p">,</span> <span class="n">_ys</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sols</span><span class="p">:</span>
    <span class="n">axm</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">t0_min</span> <span class="o">+</span> <span class="n">_ys</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">problem</span><span class="o">.</span><span class="n">TU2DAY</span><span class="p">,</span> <span class="n">_ys</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">MSTAR</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">axm</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts_mjd2000</span><span class="p">,</span> <span class="n">states_singleshoot</span><span class="p">[:,</span><span class="mi">6</span><span class="p">],</span> <span class="s1">&#39;r:&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_ex_pl2pl_32_0.png" src="../_images/examples_ex_pl2pl_32_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../examples_astrodynamics.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Astrodynamics Problems</p>
      </div>
    </a>
    <a class="right-next"
       href="../api.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">API</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Construct-a-fuel-optimal-problem">Construct a fuel-optimal problem</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Solve-fuel-optimal-problem">Solve fuel-optimal problem</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Plot-results">Plot results</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Verify-the-solution">Verify the solution</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Yuri Shimane
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, Yuri Shimane.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>